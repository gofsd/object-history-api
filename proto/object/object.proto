syntax = "proto3";

package object;

option go_package = "object/proto";
option java_multiple_files = true;
option java_package = "obj";
option java_outer_classname = "Obj";
option objc_class_prefix = "OBJ";

// ------------------- CORE MESSAGES -------------------
enum ObjectType {
  UNKNOWN_OBJECT = 0;
  ITEM = 1;
  TYPE = 2;
  GROUP = 3;
  COMMAND = 4;
  USER = 5;
  EXECUTION = 6;
  RELATION = 7;
}

message Object {
  uint64 id = 1;
  ObjectType object_type = 2;
  map<string, string> fields = 3;
}

// Single and plural responses
message ObjectResponse {
  Object object = 1;
}

message ObjectsResponse {
  repeated Object objects = 1;
}

// ------------------- CRUD REQUESTS -------------------
message CreateObjectRequest {
  map<string, string> fields = 1;
  repeated Relation relation = 2; // Optional relation for the object
}

message GetObjectRequest {
  uint64 object_id = 1;
}

message UpdateObjectRequest {
  uint64 object_id = 1;
  map<string, string> fields = 2;
  bool is_new = 3;
}

message DeleteObjectsFieldsRequest {
  repeated uint64 object_id = 1;
  map<string, string> fields = 2;
  bool is_new = 3;
  bool is_strict = 4;
}

// ------------------- BATCH/UNIQUE REQUESTS -------------------
message CreateObjectsRequest {
  map<string, string> fields = 1;
  uint32 count = 2;
  repeated Relation relation = 3; // Optional relations for the objects
}

message CreateObjectsUniqueRequest {
  repeated Object objects = 1;
}

message GetObjectsRequest {
  repeated uint64 object_id = 1;
}

message UpdateObjectsRequest {
  repeated uint64 object_id = 1;
  map<string, string> fields = 2;
  bool is_new = 3;
}

message UpdateObjectsUniqueRequest {
  repeated Object objects = 1;
}

// ------------------- LIST & PAGINATION -------------------
message ListObjectsRequest {
  int32 page = 1;
  int32 page_size = 2;
  map<string, string> fields = 3;
  int32 object_type = 4;
  repeated Relation relations = 5;
  bool is_ascending = 6;
}

message ListObjectsResponse {
  repeated Object objects = 1;
  int64 total_count = 2;
  int32 page = 3;
  int32 page_size = 4;
  int32 total_pages = 5;
}

// ------------------- ACTION/TRANSFER -------------------
message ExecuteActionRequest {
  uint64 action_id = 1;
  map<string, string> fields = 2;
}

message ExecuteActionsRequest{
  repeated ExecuteActionRequest actions = 1;
}

message ExecuteActionResponse {
  repeated Object objects = 1;
}

message TransferObjectsRequest {
  Object object = 1;
}

message TransferObjectsResponse {
  uint64 secret_transfer_id = 1;
}

message ReceiveObjectsResponse {
  repeated Object objects = 1;
}

// ------------------- SUBSCRIPTION/STREAMING -------------------

message SubscriptionResponse {
  repeated Object objects = 1;
}

message Empty{}
// Enumerate all actions

// -----------------------
// Action types
// -----------------------
enum ActionType {
  UNKNOWN_ACTION = 0;

  //System-level
  CONFIRM = 1;
  HEALTHCHECK = 2;

  // Object-level
  CREATE_OBJECT = 101;
  UPDATE_OBJECT = 102;
  DELETE_OBJECT = 103;
  READ_OBJECT   = 104;

  // Field-level
  CREATE_FIELD = 201;
  UPDATE_FIELD = 202;
  DELETE_FIELD = 203;
  READ_FIELD   = 204;

  // Value-level
  CREATE_VALUE = 301;
  WRITE_VALUE  = 302;
  READ_VALUE   = 303;

  // Relation-level
  CREATE_RELATION = 401;
  DELETE_RELATION = 402;
  READ_RELATION   = 403;
}

// -----------------------
// Per-action metadata
// -----------------------
message ActionMeta {
  uint32 action_id = 1; // unique per action, dense for varint efficiency
  // Optional future extension: map<string,string> attributes = 2;
}

// -----------------------
// Payload
// -----------------------
message ValuePayload {
  string type_hint = 1; // optional, describes payload type for polymorphic objects
  oneof kind {
    sint64  int_value    = 2; // zig-zag encoded
    double  float_value  = 3;
    bool    bool_value   = 4;
    string  string_value = 5;
    bytes   bytes_value  = 6;
    uint32  ref_id       = 7; // dictionary-mapped reference
  }
}

// -----------------------
// Core action
// -----------------------
message Action {
  ActionType action = 1;
  uint32 source_id = 2; // dense ID
  uint32 target_id = 3; // dense ID
  ValuePayload payload = 4;
  ActionMeta meta = 5;

  // Optional future extensibility
  map<string,string> attributes = 6;
}

// -----------------------
// Transaction / batch
// -----------------------
enum BatchResult {
  BATCH_UNKNOWN = 0;
  BATCH_COMMIT  = 1;
  BATCH_ABORT   = 2;
}

message ActionBatchMeta {
  uint64 transaction_id = 1; // groups all actions
  uint64 timestamp_ms   = 2; // batch time
  uint32 schema_version = 3; // protocol evolution
  BatchResult result    = 4; // commit / abort
  uint32 batch_version  = 5; // optional future extension
}

// -----------------------
// Dictionary
// -----------------------
message DictionaryEntry {
  uint32 id = 1; // unique dictionary ID
  oneof value {
    string string_value = 2;
    uint64 uint_value   = 3;
    bytes  bytes_value  = 4;
  }
}

message Dictionary {
  repeated DictionaryEntry entries = 1;
}

// Incremental dictionary updates for long-running sessions
message DictionaryUpdate {
  repeated DictionaryEntry new_entries = 1;
}

// -----------------------
// Batch container
// -----------------------
message ActionBatch {
  ActionBatchMeta meta = 1;

  // Optional dictionary updates
  Dictionary dictionary = 2;          // full dictionary (optional)
  DictionaryUpdate dictionary_update = 3; // incremental updates (optional)

  repeated Action actions = 4;
}

message DiffByUser{
  uint64 user_id = 1;
  uint64 action_id = 2;
}

message DiffByUsers {
  repeated DiffByUser diffs = 1;
}

message Relation {
  uint64 id = 1;
  uint64 target_id = 2;
}

// ------------------- SERVICE -------------------
service ObjectService {
  // CRUD
  rpc CreateObject(CreateObjectRequest) returns (ObjectResponse);
  rpc GetObject(GetObjectRequest) returns (ObjectResponse);
  rpc UpdateObject(UpdateObjectRequest) returns (ObjectResponse);
  rpc DeleteObjectField(DeleteObjectsFieldsRequest) returns (ObjectResponse);

  // Batch/Unique
  rpc CreateObjects(CreateObjectsRequest) returns (ObjectsResponse);
  rpc GetObjects(GetObjectsRequest) returns (ObjectsResponse);
  rpc UpdateObjects(UpdateObjectsRequest) returns (ObjectsResponse);
  rpc CreateObjectsUnique(CreateObjectsUniqueRequest) returns (ObjectsResponse);
  rpc UpdateObjectsUnique(UpdateObjectsUniqueRequest) returns (ObjectsResponse);

  // List & Pagination
  rpc ListObjects(ListObjectsRequest) returns (ListObjectsResponse);


  // Action/Transfer
  rpc ExecuteAction(ExecuteActionRequest) returns (ExecuteActionResponse);
  rpc ExecuteActions(ExecuteActionsRequest) returns (ExecuteActionResponse);
  rpc TransferObjects(TransferObjectsRequest) returns (TransferObjectsResponse);
  rpc ReceiveObjects(TransferObjectsResponse) returns (ReceiveObjectsResponse);

  // Streaming/Subscription
  rpc SubscribeToUsersObjects(Empty) returns (stream SubscriptionResponse);
  rpc SubscribeToMyself(Empty) returns (stream Object);
  rpc SyncWithUsers(DiffByUsers) returns (stream ActionBatch);
  rpc Sync(stream ActionBatch) returns (stream ActionBatch);

  // Get object commands
  rpc GetObjectCommands(GetObjectRequest) returns (ObjectsResponse);
}
